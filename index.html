<!DOCTYPE html>

<meta charset="utf-8" />
<style>
  @charset "UTF-8";
  div.editable {
      width: 80%;
      height: 50%;
      border: 1px solid black;
      padding: 5px;
  }
  body, html {
      background-color: black;
      color: lightgrey;
  }
  .inputtext {
      background-color: #333;
  }
</style>

<title>AberMUSH</title>

<script src="ansi_up.js" type="text/javascript"></script>
<script language="javascript" type="text/javascript">

  var ansi_up = new AnsiUp;

  function init()
  {
      document.myform.inputtext.value = ""
      document.myform.disconnectButton.disabled = true;
  }

  function doConnect()
  {
      var cdiv = document.getElementById("htmloutputtext");
      cdiv.innerHTML = "";
      websocket = new WebSocket("ws://localhost:6221/");
      websocket.onopen = function(evt) { onOpen(evt) };
      websocket.onclose = function(evt) { onClose(evt) };
      websocket.onmessage = function(evt) { onMessage(evt) };
      websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt)
  {
      writeToScreen("connected");
      document.myform.connectButton.disabled = true;
      document.myform.disconnectButton.disabled = false;
  }

  function onClose(evt)
  {
      writeToScreen("disconnected");
      document.myform.connectButton.disabled = false;
      document.myform.disconnectButton.disabled = true;
  }

  function onMessage(evt)
  {
      writeToScreen(evt.data);
  }

  function onError(evt)
  {
      writeToScreen("error: " + evt.data);

      websocket.close();

      document.myform.connectButton.disabled = false;
      document.myform.disconnectButton.disabled = true;

  }

  function doSend(message)
  {
      writeToScreen(message);
      websocket.send(message);
  }

  function writeToScreen(message)
  {
      // ignore silent messages which are used to check
      // that the client is still active
      if (message == "\x00") return;

      var cdiv = document.getElementById("htmloutputtext");

      // should the screen be cleared?
      if (message.includes("****CLEAR****")) {
	  clearText();
	  message = message.replace("****CLEAR****", "");
      }

      // split the message into lines
      var lines = message.split('\n');
      msgStr = "";
      for (var i = 0; i < lines.length; i++) {
          msgStr += ansi_up.ansi_to_html(lines[i]) + "<br>";
      }

      // NOTE: This is slow
      cdiv.innerHTML += msgStr;

      window.scrollTo(0,document.body.scrollHeight);
  }

  window.addEventListener("load", init, false);

  function sendText() {
      doSend( document.myform.inputtext.value );
  }

  function clearText() {
      var cdiv = document.getElementById("htmloutputtext");
      cdiv.innerHTML = "";
  }

  function doDisconnect() {
      websocket.close();
  }


</script>

<div id="output"></div>

<form name="myform">
  <div id="htmloutputtext" contenteditable="true"></div>
  <p>
    <textarea name="inputtext" cols="1000"></textarea>
  </p>
  <p>
    <input type="button" name=sendButton value="Send" onClick="sendText();">
    <input type="button" name=clearButton value="Clear" onClick="clearText();">
    <input type="button" name=disconnectButton value="Disconnect" onClick="doDisconnect();">
    <input type="button" name=connectButton value="Connect" onClick="doConnect();">
  </p>


</form>
</html>
